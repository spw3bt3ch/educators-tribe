{% extends "base.html" %}

{% block title %}Chat - Educators' Tribe{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Messages</h1>
    
    <div class="bg-white rounded-lg shadow-lg overflow-hidden" style="height: calc(100vh - 200px);">
        <div class="flex h-full">
            <!-- Conversations Sidebar -->
            <div class="w-1/3 border-r border-gray-200 overflow-y-auto">
                <div class="p-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Conversations</h2>
                </div>
                
                <!-- Pending Connection Requests -->
                {% if pending_requests %}
                <div class="p-4 border-b border-gray-300 bg-yellow-50">
                    <h3 class="text-sm font-semibold text-gray-900 mb-3">Connection Requests</h3>
                    <div class="space-y-3">
                        {% for request in pending_requests %}
                        <div class="p-3 bg-white rounded-lg border border-yellow-200">
                            <div class="flex items-center space-x-2 mb-2">
                                {% if request.requester.profile_picture %}
                                <img src="{{ request.requester.profile_picture }}" alt="{{ request.requester.username }}" 
                                     class="w-8 h-8 rounded-full object-cover border border-green-500">
                                {% else %}
                                <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-white text-xs font-semibold">
                                    {{ request.requester.username[0].upper() }}
                                </div>
                                {% endif %}
                                <span class="text-sm font-medium text-gray-900">{{ request.requester.full_name or request.requester.username }}</span>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="acceptRequest({{ request.id }})" class="flex-1 bg-green-600 text-white text-xs px-3 py-1 rounded hover:bg-green-700 transition">Accept</button>
                                <button onclick="rejectRequest({{ request.id }})" class="flex-1 bg-gray-300 text-gray-700 text-xs px-3 py-1 rounded hover:bg-gray-400 transition">Reject</button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Conversations List -->
                <div id="conversations-list" class="divide-y divide-gray-200">
                    {% if conversations %}
                        {% for conv in conversations %}
                        <div class="p-4 hover:bg-gray-50 cursor-pointer conversation-item" data-user-id="{{ conv.user.id }}">
                            <div class="flex items-center space-x-3">
                                {% if conv.user.profile_picture %}
                                <img src="{{ conv.user.profile_picture }}" alt="{{ conv.user.username }}" 
                                     class="w-12 h-12 rounded-full object-cover border-2 border-green-500">
                                {% else %}
                                <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center text-white font-semibold">
                                    {{ conv.user.username[0].upper() }}
                                </div>
                                {% endif %}
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-semibold text-gray-900">{{ conv.user.full_name or conv.user.username }}</p>
                                    <p class="text-xs text-gray-500">{{ conv.user.username }}</p>
                                </div>
                                {% if conv.unread_count > 0 %}
                                <span class="unread-badge bg-green-600 text-white text-xs font-bold rounded-full px-2 py-1">{{ conv.unread_count }}</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="p-4 text-center text-gray-500">
                            <p class="text-sm">No conversations yet. Connect with other educators to start chatting!</p>
                            <a href="{{ url_for('discover_users') }}" class="text-green-600 hover:text-green-800 text-sm font-semibold mt-2 inline-block">Discover Tribe Members â†’</a>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Chat Area -->
            <div class="flex-1 flex flex-col">
                <!-- Chat Header -->
                <div id="chat-header" class="p-4 border-b border-gray-200 bg-gray-50 hidden">
                    <div class="flex items-center space-x-3">
                        <div id="chat-user-avatar" class="w-10 h-10 rounded-full bg-green-600 flex items-center justify-center text-white font-semibold"></div>
                        <div>
                            <p id="chat-user-name" class="text-sm font-semibold text-gray-900"></p>
                            <p id="chat-user-status" class="text-xs text-gray-500">Online</p>
                        </div>
                    </div>
                </div>
                
                <!-- Messages Area -->
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 bg-gray-50">
                    <div id="no-chat-selected" class="flex items-center justify-center h-full text-gray-500">
                        <div class="text-center">
                            <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            <p class="text-lg font-medium">Select a conversation to start chatting</p>
                        </div>
                    </div>
                    <div id="messages-list" class="space-y-4 hidden"></div>
                    <div id="typing-indicator" class="hidden p-2 text-sm text-gray-500 italic"></div>
                </div>
                
                <!-- Message Input -->
                <div id="message-input-container" class="p-4 border-t border-gray-200 bg-white hidden">
                    <form id="message-form" class="flex space-x-2">
                        <input type="text" id="message-input" placeholder="Type a message..." 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition font-semibold">
                            Send
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io();
    let currentChatUserId = null;
    let typingTimeout = null;
    
    // Request notification permission on page load
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    
    // Initialize Socket.IO connection
    socket.on('connect', function() {
        console.log('Connected to chat server');
    });
    
    socket.on('new_message', function(data) {
        // Check if this message is for the current user (they are the recipient)
        const isForCurrentUser = data.recipient_id == {{ current_user.id }};
        
        // Check if we're currently viewing this conversation
        const isViewingConversation = currentChatUserId && 
            (data.sender_id == currentChatUserId || data.recipient_id == currentChatUserId);
        
        if (isForCurrentUser) {
            if (isViewingConversation) {
                // We're viewing this conversation - add message immediately
                addMessage(data);
                scrollToBottom();
                // Mark as read since we're viewing it
                socket.emit('mark_read', { sender_id: data.sender_id });
            } else {
                // We're not viewing this conversation - show notification and update unread count
                showNewMessageNotification(data);
                updateUnreadCount(data.sender_id);
            }
        } else {
            // This is a message we sent - add it to the chat if we're viewing this conversation
            if (isViewingConversation) {
                addMessage(data);
                scrollToBottom();
            }
        }
    });
    
    socket.on('message_sent', function(data) {
        // Message was sent successfully - add it to the chat immediately
        if (currentChatUserId && data.recipient_id == currentChatUserId) {
            addMessage(data);
            scrollToBottom();
        }
    });
    
    socket.on('user_typing', function(data) {
        if (data.user_id == currentChatUserId && data.is_typing) {
            document.getElementById('typing-indicator').textContent = data.username + ' is typing...';
            document.getElementById('typing-indicator').classList.remove('hidden');
        } else {
            document.getElementById('typing-indicator').classList.add('hidden');
        }
    });
    
    socket.on('error', function(data) {
        alert('Error: ' + data.msg);
    });
    
    // Handle conversation/user selection
    document.querySelectorAll('.conversation-item, .user-item').forEach(item => {
        item.addEventListener('click', function() {
            const userId = parseInt(this.dataset.userId);
            selectUser(userId);
        });
    });
    
    function selectUser(userId) {
        currentChatUserId = userId;
        
        // Update UI
        document.getElementById('no-chat-selected').classList.add('hidden');
        document.getElementById('messages-list').classList.remove('hidden');
        document.getElementById('chat-header').classList.remove('hidden');
        document.getElementById('message-input-container').classList.remove('hidden');
        
        // Update header
        const userItem = document.querySelector(`[data-user-id="${userId}"]`);
        const userName = userItem.querySelector('.text-sm, .text-gray-700').textContent.trim();
        const userAvatar = userItem.querySelector('img, div');
        
        document.getElementById('chat-user-name').textContent = userName;
        if (userAvatar.tagName === 'IMG') {
            document.getElementById('chat-user-avatar').innerHTML = `<img src="${userAvatar.src}" class="w-full h-full rounded-full object-cover">`;
        } else {
            document.getElementById('chat-user-avatar').textContent = userName[0].toUpperCase();
        }
        
        // Clear unread badge for this conversation
        const convItem = document.querySelector(`.conversation-item[data-user-id="${userId}"]`);
        if (convItem) {
            const badge = convItem.querySelector('.unread-badge');
            if (badge) {
                badge.remove();
            }
        }
        
        // Load messages
        loadMessages(userId);
        
        // Mark messages as read
        socket.emit('mark_read', { sender_id: userId });
    }
    
    function loadMessages(userId) {
        fetch(`/chat/api/messages/${userId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                const messagesList = document.getElementById('messages-list');
                messagesList.innerHTML = '';
                
                data.messages.forEach(msg => {
                    addMessage(msg);
                });
                
                scrollToBottom();
            })
            .catch(error => {
                console.error('Error loading messages:', error);
                alert('Failed to load messages');
            });
    }
    
    function addMessage(msg) {
        const messagesList = document.getElementById('messages-list');
        const isSent = msg.sender_id == {{ current_user.id }};
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${isSent ? 'justify-end' : 'justify-start'}`;
        
        const messageContent = document.createElement('div');
        messageContent.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${isSent ? 'bg-green-600 text-white' : 'bg-white text-gray-900 border border-gray-200'}`;
        
        if (!isSent) {
            const senderName = document.createElement('p');
            senderName.className = 'text-xs font-semibold mb-1';
            senderName.textContent = msg.sender_name;
            messageContent.appendChild(senderName);
        }
        
        const messageText = document.createElement('p');
        messageText.className = 'text-sm';
        messageText.textContent = msg.message;
        messageContent.appendChild(messageText);
        
        const time = document.createElement('p');
        time.className = `text-xs mt-1 ${isSent ? 'text-green-100' : 'text-gray-500'}`;
        const msgDate = new Date(msg.created_at);
        time.textContent = msgDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        messageContent.appendChild(time);
        
        messageDiv.appendChild(messageContent);
        messagesList.appendChild(messageDiv);
    }
    
    function scrollToBottom() {
        const container = document.getElementById('messages-container');
        container.scrollTop = container.scrollHeight;
    }
    
    function showNewMessageNotification(data) {
        // Show a browser notification if permission is granted
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(`New message from ${data.sender_name}`, {
                body: data.message.length > 50 ? data.message.substring(0, 50) + '...' : data.message,
                icon: data.sender_picture || '/static/images/default-avatar.png'
            });
        }
        
        // Update unread count badge
        updateUnreadCountBadge(data.sender_id);
    }
    
    function updateUnreadCountBadge(userId) {
        // Update unread count badge for conversation
        const convItem = document.querySelector(`.conversation-item[data-user-id="${userId}"]`);
        if (convItem) {
            // Find or create badge
            let badge = convItem.querySelector('.unread-badge');
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'unread-badge bg-green-600 text-white text-xs font-bold rounded-full px-2 py-1';
                convItem.querySelector('.flex').appendChild(badge);
            }
            // Increment count
            const currentCount = parseInt(badge.textContent) || 0;
            badge.textContent = currentCount + 1;
        } else {
            // If conversation doesn't exist in sidebar, add it
            // This would require fetching user info, but for now just update counts
            console.log('New message from user:', userId);
        }
    }
    
    // Handle message form submission
    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!currentChatUserId) return;
        
        const messageInput = document.getElementById('message-input');
        const messageText = messageInput.value.trim();
        
        if (!messageText) return;
        
        // Send message via Socket.IO
        socket.emit('send_message', {
            recipient_id: currentChatUserId,
            message: messageText
        });
        
        // Clear input
        messageInput.value = '';
        
        // Stop typing indicator
        socket.emit('typing', {
            recipient_id: currentChatUserId,
            is_typing: false
        });
        
        clearTimeout(typingTimeout);
    });
    
    // Handle typing indicator
    document.getElementById('message-input').addEventListener('input', function() {
        if (!currentChatUserId) return;
        
        socket.emit('typing', {
            recipient_id: currentChatUserId,
            is_typing: true
        });
        
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            socket.emit('typing', {
                recipient_id: currentChatUserId,
                is_typing: false
            });
        }, 1000);
    });
    
    // Handle connection requests
    function acceptRequest(requestId) {
        fetch(`/connection/accept/${requestId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Reload to update connections
            } else {
                alert('Error: ' + (data.error || 'Failed to accept request'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to accept request');
        });
    }
    
    function rejectRequest(requestId) {
        fetch(`/connection/reject/${requestId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Reload to remove request
            } else {
                alert('Error: ' + (data.error || 'Failed to reject request'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to reject request');
        });
    }
</script>
{% endblock %}


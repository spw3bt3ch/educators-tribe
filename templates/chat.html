{% extends "base.html" %}

{% block title %}Chat - Educators' Tribe{% endblock %}

{% block content %}
<!-- Notification Toast Container -->
<div id="toast-container" class="fixed top-16 right-2 sm:right-4 z-50 space-y-2 max-w-sm w-full sm:w-auto"></div>

<div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8 py-4 sm:py-8">
    <div class="flex items-center justify-between mb-4 sm:mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Messages</h1>
        <a href="{{ url_for('discover_users') }}" class="bg-green-600 hover:bg-green-700 text-white px-3 sm:px-4 py-2 rounded-lg font-semibold text-sm transition shadow-md">
            <span class="hidden sm:inline">Discover </span>Members
        </a>
    </div>
    
    <div class="bg-white rounded-lg shadow-lg overflow-hidden" style="height: calc(100vh - 140px); min-height: 500px;">
        <div class="flex flex-col lg:flex-row h-full">
            <!-- Conversations Sidebar - Hidden on mobile when chat is open -->
            <div id="conversations-sidebar" class="w-full lg:w-80 xl:w-96 border-r border-gray-200 overflow-y-auto flex flex-col lg:flex">
                <!-- Sidebar Header -->
                <div class="p-3 sm:p-4 border-b border-gray-200 bg-gray-50 sticky top-0 z-10">
                    <div class="flex items-center justify-between">
                        <h2 class="text-base sm:text-lg font-semibold text-gray-900">Conversations</h2>
                        <button id="mobile-close-sidebar" class="lg:hidden text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Pending Connection Requests -->
                {% if pending_requests %}
                <div class="p-3 sm:p-4 border-b border-gray-300 bg-yellow-50">
                    <h3 class="text-xs sm:text-sm font-semibold text-gray-900 mb-2 sm:mb-3">Connection Requests</h3>
                    <div class="space-y-2 sm:space-y-3">
                        {% for request in pending_requests %}
                        <div class="p-2 sm:p-3 bg-white rounded-lg border border-yellow-200 shadow-sm">
                            <div class="flex items-center space-x-2 mb-2">
                                {% if request.requester.profile_picture %}
                                <img src="{{ request.requester.profile_picture }}" alt="{{ request.requester.username }}" 
                                     class="w-8 h-8 sm:w-10 sm:h-10 rounded-full object-cover border border-green-500 flex-shrink-0">
                                {% else %}
                                <div class="w-8 h-8 sm:w-10 sm:h-10 bg-green-600 rounded-full flex items-center justify-center text-white text-xs sm:text-sm font-semibold flex-shrink-0">
                                    {{ request.requester.username[0].upper() }}
                                </div>
                                {% endif %}
                                <span class="text-xs sm:text-sm font-medium text-gray-900 truncate">{{ request.requester.full_name or request.requester.username }}</span>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="acceptRequest({{ request.id }})" class="flex-1 bg-green-600 text-white text-xs sm:text-sm px-3 py-1.5 sm:py-2 rounded hover:bg-green-700 transition font-semibold">Accept</button>
                                <button onclick="rejectRequest({{ request.id }})" class="flex-1 bg-gray-300 text-gray-700 text-xs sm:text-sm px-3 py-1.5 sm:py-2 rounded hover:bg-gray-400 transition font-semibold">Reject</button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Conversations List -->
                <div id="conversations-list" class="divide-y divide-gray-200 flex-1 overflow-y-auto">
                    {% if conversations %}
                        <div class="p-3 sm:p-4 border-b border-gray-300 bg-green-50">
                            <h3 class="text-xs sm:text-sm font-semibold text-gray-900">Recent Conversations</h3>
                        </div>
                        {% for conv in conversations %}
                        <div class="p-3 sm:p-4 hover:bg-green-50 cursor-pointer conversation-item transition-colors border-l-4 border-transparent hover:border-green-500 active:bg-green-100" data-user-id="{{ conv.user.id }}" title="Click to chat with {{ conv.user.full_name or conv.user.username }}">
                            <div class="flex items-center space-x-3">
                                {% if conv.user.profile_picture %}
                                <img src="{{ conv.user.profile_picture }}" alt="{{ conv.user.username }}" 
                                     class="w-10 h-10 sm:w-12 sm:h-12 rounded-full object-cover border-2 border-green-500 flex-shrink-0">
                                {% else %}
                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-green-600 rounded-full flex items-center justify-center text-white font-semibold text-sm sm:text-base flex-shrink-0">
                                    {{ conv.user.username[0].upper() }}
                                </div>
                                {% endif %}
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm sm:text-base font-semibold text-gray-900 truncate">{{ conv.user.full_name or conv.user.username }}</p>
                                    <p class="text-xs text-gray-500 truncate">@{{ conv.user.username }}</p>
                                </div>
                                {% if conv.unread_count > 0 %}
                                <span class="unread-badge bg-green-600 text-white text-xs font-bold rounded-full px-2 py-1 flex-shrink-0">{{ conv.unread_count }}</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                    
                    <!-- All Connected Users Section -->
                    {% if all_connections %}
                    <div class="p-3 sm:p-4 border-t border-gray-300 bg-blue-50">
                        <h3 class="text-xs sm:text-sm font-semibold text-gray-900 mb-2">My Connections</h3>
                        <p class="text-xs text-gray-600 mb-3">Click on any connection to start chatting</p>
                        <div class="space-y-2">
                            {% for user in all_connections %}
                            <div class="p-2 sm:p-3 bg-white rounded-lg border border-blue-200 hover:bg-blue-50 cursor-pointer conversation-item transition-all shadow-sm hover:shadow-md active:scale-95" data-user-id="{{ user.id }}" title="Click to start chatting with {{ user.full_name or user.username }}">
                                <div class="flex items-center space-x-2 sm:space-x-3">
                                    {% if user.profile_picture %}
                                    <img src="{{ user.profile_picture }}" alt="{{ user.username }}" 
                                         class="w-8 h-8 sm:w-10 sm:h-10 rounded-full object-cover border-2 border-green-500 flex-shrink-0">
                                    {% else %}
                                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-green-600 rounded-full flex items-center justify-center text-white text-xs sm:text-sm font-semibold flex-shrink-0">
                                        {{ user.username[0].upper() }}
                                    </div>
                                    {% endif %}
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs sm:text-sm font-semibold text-gray-900 truncate">{{ user.full_name or user.username }}</p>
                                        <p class="text-xs text-gray-500 truncate">@{{ user.username }}</p>
                                    </div>
                                    <svg class="w-4 h-4 sm:w-5 sm:h-5 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    </svg>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if not conversations and not all_connections %}
                        <div class="p-4 sm:p-6 text-center text-gray-500">
                            <svg class="w-12 h-12 sm:w-16 sm:h-16 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            <p class="text-xs sm:text-sm mb-2">No connections yet. Connect with other educators to start chatting!</p>
                            <a href="{{ url_for('discover_users') }}" class="text-green-600 hover:text-green-800 text-xs sm:text-sm font-semibold mt-2 inline-block">Discover Tribe Members â†’</a>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Chat Area -->
            <div class="flex-1 flex flex-col min-w-0">
                <!-- Chat Header - Shows back button on mobile -->
                <div id="chat-header" class="p-3 sm:p-4 border-b border-gray-200 bg-gradient-to-r from-green-50 to-white hidden">
                    <div class="flex items-center space-x-3">
                        <button id="mobile-back-button" class="lg:hidden text-gray-600 hover:text-gray-800 mr-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <div id="chat-user-avatar" class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-green-600 flex items-center justify-center text-white font-semibold flex-shrink-0"></div>
                        <div class="flex-1 min-w-0">
                            <p id="chat-user-name" class="text-sm sm:text-base font-semibold text-gray-900 truncate"></p>
                            <p id="chat-user-status" class="text-xs text-gray-500">Online</p>
                        </div>
                    </div>
                </div>
                
                <!-- Messages Area -->
                <div id="messages-container" class="flex-1 overflow-y-auto bg-gray-50 flex flex-col">
                    <div id="no-chat-selected" class="flex items-center justify-center h-full text-gray-500">
                        <div class="text-center px-4">
                            <svg class="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            <p class="text-base sm:text-lg font-medium">Select a conversation to start chatting</p>
                            <p class="text-sm text-gray-400 mt-2">Choose a connection from the sidebar</p>
                        </div>
                    </div>
                    <div id="messages-list" class="flex-1 p-3 sm:p-4 space-y-3 sm:space-y-4 flex flex-col justify-end hidden"></div>
                    <div id="typing-indicator" class="hidden px-3 sm:px-4 pb-2 text-sm text-gray-500 italic"></div>
                </div>
                
                <!-- Message Input - Always Visible -->
                <div id="message-input-container" class="p-4 sm:p-5 border-t-2 border-gray-200 bg-white shadow-xl">
                    <form id="message-form" class="flex items-end gap-3">
                        <div class="flex-1 relative bg-gray-100 rounded-full border-2 border-gray-200 focus-within:border-green-500 focus-within:bg-white transition-all">
                            <textarea id="message-input" rows="1" placeholder="Type a message..." 
                                      class="w-full px-5 py-3 pr-12 text-sm sm:text-base bg-transparent border-0 rounded-full focus:outline-none resize-none overflow-hidden"
                                      style="max-height: 120px; min-height: 48px; line-height: 1.5;"></textarea>
                            <button type="button" id="emoji-button" class="absolute right-3 bottom-3 text-gray-500 hover:text-green-600 transition p-1" title="Add emoji">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </button>
                        </div>
                        <button type="submit" id="send-button" class="bg-green-600 text-white p-3 sm:p-4 rounded-full hover:bg-green-700 transition-all font-semibold shadow-lg hover:shadow-xl active:scale-95 flex items-center justify-center min-w-[56px] h-[56px] disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const socket = io();
    let currentChatUserId = null;
    let typingTimeout = null;
    
    // Mobile sidebar toggle
    const sidebar = document.getElementById('conversations-sidebar');
    const mobileCloseBtn = document.getElementById('mobile-close-sidebar');
    const mobileBackBtn = document.getElementById('mobile-back-button');
    
    if (mobileCloseBtn) {
        mobileCloseBtn.addEventListener('click', () => {
            sidebar.classList.add('hidden');
        });
    }
    
    if (mobileBackBtn) {
        mobileBackBtn.addEventListener('click', () => {
            sidebar.classList.remove('hidden');
            document.getElementById('chat-header').classList.add('hidden');
            document.getElementById('messages-list').classList.add('hidden');
            document.getElementById('no-chat-selected').classList.remove('hidden');
            // Disable input when no chat selected
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            messageInput.disabled = true;
            messageInput.placeholder = 'Select a conversation to start chatting...';
            messageInput.value = '';
            sendButton.disabled = true;
            currentChatUserId = null;
        });
    }
    
    // Request notification permission on page load
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    
    // Toast notification system
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        
        const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        
        toast.className = `${bgColor} text-white px-4 sm:px-6 py-3 sm:py-4 rounded-lg shadow-lg flex items-center space-x-3 min-w-[280px] sm:min-w-[300px] max-w-sm animate-slide-in`;
        toast.innerHTML = `
            <div class="flex-shrink-0">
                ${type === 'success' ? 
                    '<svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' :
                    type === 'error' ?
                    '<svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' :
                    '<svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
                }
            </div>
            <div class="flex-1">
                <p class="font-semibold text-sm sm:text-base">${message}</p>
            </div>
            <button onclick="this.parentElement.remove()" class="flex-shrink-0 text-white hover:text-gray-200 transition">
                <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `;
        
        container.appendChild(toast);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.style.animation = 'slide-out 0.3s ease-out';
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 300);
        }, 5000);
    }
    
    // Initialize Socket.IO connection
    socket.on('connect', function() {
        console.log('Connected to chat server');
    });
    
    // Listen for new connection requests
    socket.on('new_connection_request', function(data) {
        showToast(`ðŸŽ¯ New connection request from ${data.requester_name}!`, 'success');
        // Reload page to show new request
        setTimeout(() => {
            location.reload();
        }, 2000);
    });
    
    // Get current user ID from template
    const currentUserId = {{ current_user.id }};
    
    socket.on('new_message', function(data) {
        // Check if this message is for the current user (they are the recipient)
        const isForCurrentUser = data.recipient_id == currentUserId;
        
        // Check if we're currently viewing this conversation
        const isViewingConversation = currentChatUserId && 
            (data.sender_id == currentChatUserId || data.recipient_id == currentChatUserId);
        
        if (isForCurrentUser) {
            if (isViewingConversation) {
                // We're viewing this conversation - add message immediately
                addMessage(data);
                scrollToBottom();
                // Mark as read since we're viewing it
                socket.emit('mark_read', { sender_id: data.sender_id });
            } else {
                // We're not viewing this conversation - show notification and update unread count
                showNewMessageNotification(data);
                updateUnreadCountBadge(data.sender_id);
            }
        } else {
            // This is a message we sent - add it to the chat if we're viewing this conversation
            if (isViewingConversation) {
                addMessage(data);
                scrollToBottom();
            }
        }
    });
    
    socket.on('message_sent', function(data) {
        // Message was sent successfully - update the temporary message or add it
        if (currentChatUserId && data.recipient_id == currentChatUserId) {
            // Find and remove the temporary message if it exists
            const messagesList = document.getElementById('messages-list');
            
            // Find all temporary messages and remove the most recent one (last one added)
            const tempMessageDivs = Array.from(messagesList.querySelectorAll(`[data-temp-id]`));
            if (tempMessageDivs.length > 0) {
                // Remove the last temporary message (most recent)
                const lastTempDiv = tempMessageDivs[tempMessageDivs.length - 1];
                const tempId = lastTempDiv.dataset.tempId;
                if (pendingMessages.has(tempId)) {
                    lastTempDiv.remove();
                    pendingMessages.delete(tempId);
                }
            }
            
            // Add the actual message with sent status
            data.status = 'sent';
            addMessage(data);
            scrollToBottom();
            
            // Re-enable send button
            const sendButton = document.getElementById('send-button');
            const messageInput = document.getElementById('message-input');
            if (messageInput && messageInput.value.trim().length === 0) {
                sendButton.disabled = true;
            } else {
                sendButton.disabled = false;
            }
        }
    });
    
    socket.on('error', function(data) {
        // Handle sending errors
        if (data.type === 'message_error') {
            showToast('Failed to send message: ' + (data.msg || 'Unknown error'), 'error');
            
            // Remove the temporary message on error
            const messagesList = document.getElementById('messages-list');
            const tempMessageDivs = messagesList.querySelectorAll(`[data-temp-id]`);
            tempMessageDivs.forEach(div => {
                const tempId = div.dataset.tempId;
                if (pendingMessages.has(tempId)) {
                    div.remove();
                    pendingMessages.delete(tempId);
                }
            });
            
            // Re-enable send button
            const sendButton = document.getElementById('send-button');
            const messageInput = document.getElementById('message-input');
            if (messageInput && messageInput.value.trim().length > 0) {
                sendButton.disabled = false;
            }
        } else {
            showToast('Error: ' + (data.msg || 'Unknown error'), 'error');
        }
    });
    
    socket.on('user_typing', function(data) {
        if (data.user_id == currentChatUserId && data.is_typing) {
            document.getElementById('typing-indicator').textContent = data.username + ' is typing...';
            document.getElementById('typing-indicator').classList.remove('hidden');
        } else {
            document.getElementById('typing-indicator').classList.add('hidden');
        }
    });
    
    // Handle conversation/user selection
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.addEventListener('click', function() {
            const userId = parseInt(this.dataset.userId);
            selectUser(userId);
            
            // On mobile, hide sidebar and show chat
            if (window.innerWidth < 1024) {
                sidebar.classList.add('hidden');
            }
        });
    });
    
    function selectUser(userId) {
        currentChatUserId = userId;
        
        // Update UI
        document.getElementById('no-chat-selected').classList.add('hidden');
        const messagesList = document.getElementById('messages-list');
        messagesList.classList.remove('hidden');
        document.getElementById('chat-header').classList.remove('hidden');
        // Message input is always visible, just enable it
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        messageInput.disabled = false;
        messageInput.placeholder = 'Type a message...';
        sendButton.disabled = false;
        
        // Update header
        const userItem = document.querySelector(`[data-user-id="${userId}"]`);
        const userName = userItem.querySelector('.text-sm, .text-base').textContent.trim();
        const userAvatar = userItem.querySelector('img, div');
        
        document.getElementById('chat-user-name').textContent = userName;
        if (userAvatar.tagName === 'IMG') {
            document.getElementById('chat-user-avatar').innerHTML = `<img src="${userAvatar.src}" class="w-full h-full rounded-full object-cover">`;
        } else {
            document.getElementById('chat-user-avatar').textContent = userName[0].toUpperCase();
        }
        
        // Clear unread badge for this conversation
        const convItem = document.querySelector(`.conversation-item[data-user-id="${userId}"]`);
        if (convItem) {
            const badge = convItem.querySelector('.unread-badge');
            if (badge) {
                badge.remove();
            }
        }
        
        // Load messages
        loadMessages(userId);
        
        // Mark messages as read
        socket.emit('mark_read', { sender_id: userId });
        
        // Focus input after a short delay
        setTimeout(() => {
            messageInput.focus();
        }, 300);
    }
    
    function loadMessages(userId) {
        const messagesList = document.getElementById('messages-list');
        const noChatSelected = document.getElementById('no-chat-selected');
        
        if (!messagesList) {
            console.error('Messages list element not found');
            return;
        }
        
        // Hide no-chat-selected and show messages list
        if (noChatSelected) {
            noChatSelected.classList.add('hidden');
        }
        messagesList.classList.remove('hidden');
        
        // Show loading state
        messagesList.innerHTML = '<div class="flex-1 flex items-center justify-center"><div class="text-center text-gray-500 py-8"><p class="text-sm">Loading messages...</p></div></div>';
        
        fetch(`/chat/api/messages/${userId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    messagesList.innerHTML = `<div class="flex-1 flex items-center justify-center"><div class="text-center text-red-500 py-8"><p class="text-sm">${data.error}</p></div></div>`;
                    showToast('Error: ' + data.error, 'error');
                    return;
                }
                
                messagesList.innerHTML = '';
                
                if (!data.messages || data.messages.length === 0) {
                    messagesList.innerHTML = '<div class="flex-1 flex items-center justify-center"><div class="text-center text-gray-500 py-8"><p class="text-sm">No messages yet. Start the conversation!</p></div></div>';
                } else {
                    console.log(`Loading ${data.messages.length} messages`);
                    data.messages.forEach(msg => {
                        addMessage(msg);
                    });
                    scrollToBottom();
                }
            })
            .catch(error => {
                console.error('Error loading messages:', error);
                messagesList.innerHTML = '<div class="flex-1 flex items-center justify-center"><div class="text-center text-red-500 py-8"><p class="text-sm">Failed to load messages</p></div></div>';
                showToast('Failed to load messages. Please try again.', 'error');
            });
    }
    
    function addMessage(msg, isTemporary = false) {
        const messagesList = document.getElementById('messages-list');
        
        if (!messagesList) {
            console.error('Messages list element not found');
            return;
        }
        
        // Ensure messages list is visible
        if (messagesList.classList.contains('hidden')) {
            messagesList.classList.remove('hidden');
        }
        
        // Ensure no-chat-selected is hidden
        const noChatSelected = document.getElementById('no-chat-selected');
        if (noChatSelected && !noChatSelected.classList.contains('hidden')) {
            noChatSelected.classList.add('hidden');
        }
        
        const isSent = msg.sender_id == currentUserId;
        const status = msg.status || 'sent'; // sending, sent, delivered, read
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${isSent ? 'justify-end' : 'justify-start'} w-full`;
        
        // Add data-temp-id for temporary messages
        if (isTemporary && msg.id) {
            messageDiv.setAttribute('data-temp-id', msg.id);
        }
        
        // Add opacity for sending messages
        if (status === 'sending') {
            messageDiv.style.opacity = '0.7';
        }
        
        const messageContent = document.createElement('div');
        messageContent.className = `max-w-xs sm:max-w-md lg:max-w-lg px-4 py-3 rounded-2xl ${isSent ? 'bg-green-600 text-white rounded-br-none' : 'bg-white text-gray-900 border border-gray-200 shadow-sm rounded-bl-none'}`;
        
        if (!isSent && msg.sender_name) {
            const senderName = document.createElement('p');
            senderName.className = 'text-xs font-semibold mb-1 text-gray-700';
            senderName.textContent = msg.sender_name;
            messageContent.appendChild(senderName);
        }
        
        const messageText = document.createElement('p');
        messageText.className = `text-sm sm:text-base break-words ${isSent ? 'text-white' : 'text-gray-900'}`;
        messageText.textContent = msg.message || '';
        messageContent.appendChild(messageText);
        
        // Time and status row
        const timeStatusRow = document.createElement('div');
        timeStatusRow.className = `flex items-center justify-end gap-1.5 mt-1.5 ${isSent ? '' : 'justify-start'}`;
        
        const time = document.createElement('span');
        time.className = `text-xs ${isSent ? 'text-green-100' : 'text-gray-500'}`;
        if (msg.created_at) {
            const msgDate = new Date(msg.created_at);
            time.textContent = msgDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        timeStatusRow.appendChild(time);
        
        // Add status indicator for sent messages
        if (isSent) {
            const statusIcon = document.createElement('span');
            statusIcon.className = 'inline-flex items-center';
            
            if (status === 'sending') {
                // Show spinner for sending
                statusIcon.innerHTML = `
                    <svg class="w-3 h-3 text-green-100 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                `;
            } else if (status === 'sent') {
                // Show single checkmark for sent
                statusIcon.innerHTML = `
                    <svg class="w-3.5 h-3.5 text-green-100" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                `;
            } else if (status === 'delivered' || status === 'read') {
                // Show double checkmark for delivered/read
                statusIcon.innerHTML = `
                    <svg class="w-3.5 h-3.5 text-green-100" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path>
                        <path d="M15.707 4.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" opacity="0.5"></path>
                    </svg>
                `;
            }
            
            timeStatusRow.appendChild(statusIcon);
        }
        
        messageContent.appendChild(timeStatusRow);
        messageDiv.appendChild(messageContent);
        messagesList.appendChild(messageDiv);
    }
    
    function scrollToBottom() {
        const messagesList = document.getElementById('messages-list');
        if (messagesList) {
            messagesList.scrollTop = messagesList.scrollHeight;
        }
        const container = document.getElementById('messages-container');
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    }
    
    function showNewMessageNotification(data) {
        // Show a browser notification if permission is granted
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification(`New message from ${data.sender_name}`, {
                body: data.message.length > 50 ? data.message.substring(0, 50) + '...' : data.message,
                icon: data.sender_picture || '/static/images/default-avatar.png'
            });
        }
        
        // Show toast notification
        showToast(`ðŸ’¬ New message from ${data.sender_name}`, 'success');
        
        // Update unread count badge
        updateUnreadCountBadge(data.sender_id);
    }
    
    function updateUnreadCountBadge(userId) {
        // Update unread count badge for conversation
        const convItem = document.querySelector(`.conversation-item[data-user-id="${userId}"]`);
        if (convItem) {
            // Find or create badge
            let badge = convItem.querySelector('.unread-badge');
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'unread-badge bg-green-600 text-white text-xs font-bold rounded-full px-2 py-1 flex-shrink-0';
                convItem.querySelector('.flex').appendChild(badge);
            }
            // Increment count
            const currentCount = parseInt(badge.textContent) || 0;
            badge.textContent = currentCount + 1;
        }
    }
    
    // Initialize input on page load
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    
    // Disable input initially if no conversation is selected
    if (!currentChatUserId) {
        messageInput.disabled = true;
        messageInput.placeholder = 'Select a conversation to start chatting...';
        sendButton.disabled = true;
    }
    
    // Auto-expand textarea
    function autoExpandTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }
    
    messageInput.addEventListener('input', function() {
        autoExpandTextarea(this);
        
        // Enable/disable send button based on input
        const sendButton = document.getElementById('send-button');
        if (this.value.trim().length > 0 && currentChatUserId) {
            sendButton.disabled = false;
        } else {
            sendButton.disabled = true;
        }
        
        if (!currentChatUserId) return;
        
        // Handle typing indicator
        socket.emit('typing', {
            recipient_id: currentChatUserId,
            is_typing: true
        });
        
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            socket.emit('typing', {
                recipient_id: currentChatUserId,
                is_typing: false
            });
        }, 1000);
    });
    
    // Handle Enter key (Shift+Enter for new line, Enter to send)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('message-form').dispatchEvent(new Event('submit'));
        }
    });
    
    // Track pending messages by message ID
    const pendingMessages = new Map();
    
    // Handle message form submission
    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!currentChatUserId) return;
        
        const messageText = messageInput.value.trim();
        
        if (!messageText) return;
        
        // Create temporary message with "sending" status
        const tempMessageId = 'temp_' + Date.now();
        const tempMessage = {
            id: tempMessageId,
            sender_id: currentUserId,
            recipient_id: currentChatUserId,
            message: messageText,
            created_at: new Date().toISOString(),
            sender_name: 'You',
            status: 'sending'
        };
        
        // Add temporary message to chat immediately
        addMessage(tempMessage, true);
        pendingMessages.set(tempMessageId, tempMessage);
        
        // Clear input and reset height
        messageInput.value = '';
        messageInput.style.height = '48px';
        
        // Disable send button temporarily
        const sendButton = document.getElementById('send-button');
        sendButton.disabled = true;
        
        // Stop typing indicator
        socket.emit('typing', {
            recipient_id: currentChatUserId,
            is_typing: false
        });
        
        clearTimeout(typingTimeout);
        
        // Send message via Socket.IO
        socket.emit('send_message', {
            recipient_id: currentChatUserId,
            message: messageText
        });
        
        scrollToBottom();
    });
    
    // Handle connection requests
    function acceptRequest(requestId) {
        fetch(`/connection/accept/${requestId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('âœ… Connection request accepted! You can now chat.', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showToast(data.error || 'Failed to accept request', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Failed to accept request. Please try again.', 'error');
        });
    }
    
    function rejectRequest(requestId) {
        fetch(`/connection/reject/${requestId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Request rejected', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showToast(data.error || 'Failed to reject request', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Failed to reject request. Please try again.', 'error');
        });
    }
</script>

<style>
    @keyframes slide-in {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slide-out {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    .animate-slide-in {
        animation: slide-in 0.3s ease-out;
    }
    
    /* Mobile responsive adjustments */
    @media (max-width: 1023px) {
        #conversations-sidebar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            background: white;
        }
    }
</style>
{% endblock %}

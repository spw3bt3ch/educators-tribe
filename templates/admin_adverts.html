{% extends "base.html" %}

{% block title %}Manage Advertisements - Admin Dashboard{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Manage Advertisements</h1>
            <p class="text-gray-600">Review and manage user-submitted advertisements</p>
        </div>
        <a href="{{ url_for('admin_dashboard') }}" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold transition">
            Back to Dashboard
        </a>
    </div>
    
    {% if adverts %}
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submitted By</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submitted</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for advert in adverts %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ advert.id }}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                            <div class="flex items-center">
                                {% if advert.image_url %}
                                <img src="{{ advert.image_url }}" alt="{{ advert.title }}" class="w-12 h-12 object-cover rounded mr-3">
                                {% endif %}
                                <div>
                                    <div class="font-medium">{{ advert.title }}</div>
                                    {% if advert.description %}
                                    <div class="text-xs text-gray-500 line-clamp-1">{{ advert.description[:50] }}...</div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ advert.user.username }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            {% if advert.amount %}‚Ç¶{{ "%.2f"|format(advert.amount) }}{% else %}N/A{% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if advert.status == 'pending' %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>
                            {% elif advert.status == 'approved' %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Approved</span>
                            {% elif advert.status == 'rejected' %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Rejected</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if advert.payment_status == 'paid' %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Paid</span>
                            {% elif advert.payment_status == 'pending' %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>
                            {% else %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Unpaid</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            {% if advert.submitted_at is string %}
                                {{ advert.submitted_at[:10] }}
                            {% else %}
                                {{ advert.submitted_at.strftime('%Y-%m-%d') }}
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex items-center gap-2 flex-wrap">
                                <button onclick="showAdvertDetails('{{ advert.id }}')" 
                                        class="text-blue-600 hover:text-blue-900 hover:underline px-2 py-1">
                                    View
                                </button>
                                {% if advert.status == 'pending' %}
                                <button onclick="showApproveModal('{{ advert.id }}')" 
                                        class="text-green-600 hover:text-green-900 hover:underline px-2 py-1">
                                    Approve
                                </button>
                                <button onclick="showRejectModal('{{ advert.id }}')" 
                                        class="text-red-600 hover:text-red-900 hover:underline px-2 py-1">
                                    Reject
                                </button>
                                {% endif %}
                                {% if advert.status == 'approved' %}
                                <form action="{{ url_for('deactivate_advert', advert_id=advert.id) }}" method="POST" class="inline-block" 
                                      onsubmit="return confirm('Are you sure you want to deactivate this advert?');">
                                    <button type="submit" 
                                            class="text-orange-600 hover:text-orange-900 hover:underline px-2 py-1">
                                        Deactivate
                                    </button>
                                </form>
                                {% endif %}
                                <span class="text-gray-300 select-none">|</span>
                                <form action="{{ url_for('delete_advert', advert_id=advert.id) }}" method="POST" class="inline-block" 
                                      onsubmit="return confirm('‚ö†Ô∏è WARNING: Are you sure you want to DELETE this advert?\n\nThis will PERMANENTLY delete:\n‚Ä¢ The advertisement\n‚Ä¢ All related data\n\nThis action CANNOT be undone!');">
                                    <button type="submit" 
                                            class="bg-red-600 hover:bg-red-700 text-white font-semibold px-3 py-1 rounded transition shadow-sm hover:shadow text-xs">
                                        üóëÔ∏è Delete
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="bg-white rounded-lg shadow p-12 text-center">
        <p class="text-gray-600">No advertisements submitted yet.</p>
    </div>
    {% endif %}
</div>

<!-- Approve Modal -->
<div id="approveModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
        <h3 class="text-2xl font-bold text-gray-900 mb-4">Approve Advertisement</h3>
        <form id="approveForm" method="POST" class="space-y-4">
            <div>
                <label for="approve_payment_status" class="block text-sm font-medium text-gray-700 mb-2">Payment Status</label>
                <select id="approve_payment_status" name="payment_status" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    <option value="paid">Paid</option>
                    <option value="pending">Pending</option>
                    <option value="unpaid">Unpaid</option>
                </select>
            </div>
            <div>
                <label for="approve_admin_notes" class="block text-sm font-medium text-gray-700 mb-2">Admin Notes</label>
                <textarea id="approve_admin_notes" name="admin_notes" rows="3"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                          placeholder="Optional notes"></textarea>
            </div>
            <div class="flex space-x-4">
                <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                    Approve
                </button>
                <button type="button" onclick="closeApproveModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Reject Modal -->
<div id="rejectModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
        <h3 class="text-2xl font-bold text-gray-900 mb-4">Reject Advertisement</h3>
        <form id="rejectForm" method="POST" class="space-y-4">
            <div>
                <label for="reject_admin_notes" class="block text-sm font-medium text-gray-700 mb-2">Reason for Rejection</label>
                <textarea id="reject_admin_notes" name="admin_notes" rows="3" required
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                          placeholder="Please provide a reason for rejection"></textarea>
            </div>
            <div class="flex space-x-4">
                <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                    Reject
                </button>
                <button type="button" onclick="closeRejectModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
const advertsData = [
    {% for advert in adverts %}
    {
        id: "{{ advert.id }}",
        title: "{{ advert.title|e }}",
        description: "{{ (advert.description or '')|e }}",
        link_url: "{{ (advert.link_url or '')|e }}",
        amount: {{ advert.amount or 0 }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

function showApproveModal(advertId) {
    const modal = document.getElementById('approveModal');
    const form = document.getElementById('approveForm');
    form.action = `/admin/advert/${advertId}/approve`;
    modal.classList.remove('hidden');
}

function closeApproveModal() {
    document.getElementById('approveModal').classList.add('hidden');
}

function showRejectModal(advertId) {
    const modal = document.getElementById('rejectModal');
    const form = document.getElementById('rejectForm');
    form.action = `/admin/advert/${advertId}/reject`;
    modal.classList.remove('hidden');
}

function closeRejectModal() {
    document.getElementById('rejectModal').classList.add('hidden');
}

function showAdvertDetails(advertId) {
    // Find advert in the page data
    const advertRow = document.querySelector(`[data-advert-id="${advertId}"]`);
    if (advertRow) {
        const title = advertRow.dataset.title || 'N/A';
        const description = advertRow.dataset.description || 'N/A';
        const linkUrl = advertRow.dataset.linkUrl || 'N/A';
        const amount = advertRow.dataset.amount || 'N/A';
        alert(`Title: ${title}\n\nDescription: ${description}\n\nLink: ${linkUrl}\n\nAmount: ${amount !== 'N/A' ? '‚Ç¶' + parseFloat(amount).toFixed(2) : 'N/A'}`);
    } else if (typeof advertsData !== 'undefined') {
        const advert = advertsData.find(a => String(a.id) === String(advertId));
        if (advert) {
            alert(`Title: ${advert.title}\n\nDescription: ${advert.description || 'N/A'}\n\nLink: ${advert.link_url || 'N/A'}\n\nAmount: ${advert.amount ? '‚Ç¶' + advert.amount.toFixed(2) : 'N/A'}`);
        }
    }
}
</script>
{% endblock %}


{% extends "base.html" %}

{% block title %}Manage Advertisements - Admin Dashboard{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Manage Advertisements</h1>
            <p class="text-gray-600">Review and manage user-submitted advertisements</p>
        </div>
        <div class="flex gap-3">
            <a href="{{ url_for('create_advert') }}" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                ‚ûï Create Advert (Free)
            </a>
            <a href="{{ url_for('admin_dashboard') }}" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                Back to Dashboard
            </a>
        </div>
    </div>
    
    {% if adverts %}
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submitted By</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for advert in adverts %}
                    <tr class="hover:bg-gray-50" data-advert-id="{{ advert.id }}" 
                        data-title="{{ advert.title }}" 
                        data-description="{{ advert.description or '' }}" 
                        data-link-url="{{ advert.link_url or '' }}" 
                        data-button-text="{{ advert.button_text or 'Learn More' }}"
                        data-image-url="{{ advert.image_url or '' }}"
                        data-amount="{{ advert.amount or 0 }}"
                        data-weeks="{{ advert.weeks or 1 }}"
                        data-status="{{ advert.status }}"
                        data-payment-status="{{ advert.payment_status }}"
                        data-submitted-by="{{ advert.user.username }}"
                        data-submitted-at="{% if advert.submitted_at is string %}{{ advert.submitted_at[:19] }}{% else %}{{ advert.submitted_at.strftime('%Y-%m-%d %H:%M') }}{% endif %}"
                        data-approved-at="{% if advert.approved_at %}{% if advert.approved_at is string %}{{ advert.approved_at[:19] }}{% else %}{{ advert.approved_at.strftime('%Y-%m-%d %H:%M') }}{% endif %}{% else %}N/A{% endif %}"
                        data-start-date="{% if advert.start_date %}{% if advert.start_date is string %}{{ advert.start_date[:19] }}{% else %}{{ advert.start_date.strftime('%Y-%m-%d %H:%M') }}{% endif %}{% else %}N/A{% endif %}"
                        data-end-date="{% if advert.end_date %}{% if advert.end_date is string %}{{ advert.end_date[:19] }}{% else %}{{ advert.end_date.strftime('%Y-%m-%d %H:%M') }}{% endif %}{% else %}N/A{% endif %}"
                        data-admin-notes="{{ advert.admin_notes or '' }}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ advert.id }}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                            <div class="flex items-center">
                                {% if advert.image_url %}
                                <img src="{{ advert.image_url }}" alt="{{ advert.title }}" class="w-12 h-12 object-cover rounded mr-3">
                                {% endif %}
                                <div>
                                    <div class="font-medium">{{ advert.title }}</div>
                                    {% if advert.description %}
                                    <div class="text-xs text-gray-500 line-clamp-1">{{ advert.description[:50] }}...</div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ advert.user.username }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            <span class="font-semibold">{{ advert.weeks or 1 }}</span> week{% if advert.weeks != 1 %}s{% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            {% if advert.amount %}‚Ç¶{{ "%.2f"|format(advert.amount) }}{% else %}N/A{% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if advert.status == 'pending' %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>
                            {% elif advert.status == 'approved' %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Approved</span>
                            {% elif advert.status == 'active' %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Active</span>
                            {% elif advert.status == 'expired' %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Expired</span>
                            {% elif advert.status == 'rejected' %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Rejected</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if advert.payment_status == 'paid' %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Paid</span>
                            {% elif advert.payment_status == 'pending' %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>
                            {% else %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Unpaid</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            {% if advert.status == 'active' and advert.end_date %}
                                <div class="text-xs">
                                    <div class="mb-1">
                                        <span class="font-semibold text-blue-700">‚è±Ô∏è Countdown:</span>
                                        <div id="countdown-admin-{{ advert.id }}" class="inline-flex gap-1 ml-1">
                                            <span class="font-bold text-blue-700" id="days-admin-{{ advert.id }}">0</span><span class="text-blue-600">d</span>
                                            <span class="font-bold text-blue-700" id="hours-admin-{{ advert.id }}">0</span><span class="text-blue-600">h</span>
                                            <span class="font-bold text-blue-700" id="minutes-admin-{{ advert.id }}">0</span><span class="text-blue-600">m</span>
                                        </div>
                                    </div>
                                    <div class="text-gray-500 text-xs mt-1">
                                        Ends: {% if advert.end_date is string %}{{ advert.end_date[:10] }}{% else %}{{ advert.end_date.strftime('%Y-%m-%d') }}{% endif %}
                                    </div>
                                    <script>
                                        (function() {
                                            {% if advert.end_date and not (advert.end_date is string) %}
                                            const endDate = new Date('{{ advert.end_date.strftime("%Y-%m-%d %H:%M:%S") }}');
                                            {% else %}
                                            const endDate = new Date('{{ advert.end_date }}');
                                            {% endif %}
                                            const advertId = {{ advert.id }};
                                            
                                            function updateCountdown() {
                                                const now = new Date().getTime();
                                                const distance = endDate.getTime() - now;
                                                
                                                if (distance < 0) {
                                                    document.getElementById('countdown-admin-' + advertId).innerHTML = '<span class="text-red-600 font-semibold">Expired</span>';
                                                    return;
                                                }
                                                
                                                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                                                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                                                
                                                document.getElementById('days-admin-' + advertId).textContent = days;
                                                document.getElementById('hours-admin-' + advertId).textContent = hours;
                                                document.getElementById('minutes-admin-' + advertId).textContent = minutes;
                                            }
                                            
                                            updateCountdown();
                                            setInterval(updateCountdown, 60000); // Update every minute
                                        })();
                                    </script>
                                </div>
                            {% elif advert.start_date and advert.end_date %}
                                <div class="text-xs">
                                    <div><strong>Start:</strong> {% if advert.start_date is string %}{{ advert.start_date[:10] }}{% else %}{{ advert.start_date.strftime('%Y-%m-%d') }}{% endif %}</div>
                                    <div><strong>End:</strong> {% if advert.end_date is string %}{{ advert.end_date[:10] }}{% else %}{{ advert.end_date.strftime('%Y-%m-%d') }}{% endif %}</div>
                                </div>
                            {% elif advert.submitted_at %}
                                <div class="text-xs text-gray-500">
                                    Submitted: {% if advert.submitted_at is string %}{{ advert.submitted_at[:10] }}{% else %}{{ advert.submitted_at.strftime('%Y-%m-%d') }}{% endif %}
                                </div>
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex items-center gap-2 flex-wrap">
                                <button onclick="showAdvertDetails('{{ advert.id }}')" 
                                        class="text-blue-600 hover:text-blue-900 hover:underline px-2 py-1">
                                    View
                                </button>
                                {% if advert.status == 'pending' %}
                                <button onclick="showApproveModal('{{ advert.id }}')" 
                                        class="text-green-600 hover:text-green-900 hover:underline px-2 py-1">
                                    Approve
                                </button>
                                <button onclick="showRejectModal('{{ advert.id }}')" 
                                        class="text-red-600 hover:text-red-900 hover:underline px-2 py-1">
                                    Reject
                                </button>
                                {% endif %}
                                {% if advert.status == 'active' or advert.status == 'approved' %}
                                <form action="{{ url_for('deactivate_advert', advert_id=advert.id) }}" method="POST" class="inline-block" 
                                      onsubmit="return confirm('Are you sure you want to deactivate this advert?');">
                                    <button type="submit" 
                                            class="text-orange-600 hover:text-orange-900 hover:underline px-2 py-1">
                                        Deactivate
                                    </button>
                                </form>
                                {% endif %}
                                <span class="text-gray-300 select-none">|</span>
                                <form action="{{ url_for('delete_advert', advert_id=advert.id) }}" method="POST" class="inline-block" 
                                      onsubmit="return confirm('‚ö†Ô∏è WARNING: Are you sure you want to DELETE this advert?\n\nThis will PERMANENTLY delete:\n‚Ä¢ The advertisement\n‚Ä¢ All related data\n\nThis action CANNOT be undone!');">
                                    <button type="submit" 
                                            class="bg-red-600 hover:bg-red-700 text-white font-semibold px-3 py-1 rounded transition shadow-sm hover:shadow text-xs">
                                        üóëÔ∏è Delete
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="bg-white rounded-lg shadow p-12 text-center">
        <p class="text-gray-600">No advertisements submitted yet.</p>
    </div>
    {% endif %}
</div>

<!-- Approve Modal -->
<div id="approveModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
        <h3 class="text-2xl font-bold text-gray-900 mb-4">Approve Advertisement</h3>
        <form id="approveForm" method="POST" class="space-y-4">
            <div>
                <label for="approve_payment_status" class="block text-sm font-medium text-gray-700 mb-2">Payment Status</label>
                <select id="approve_payment_status" name="payment_status" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    <option value="paid">Paid</option>
                    <option value="pending">Pending</option>
                    <option value="unpaid">Unpaid</option>
                </select>
            </div>
            <div>
                <label for="approve_admin_notes" class="block text-sm font-medium text-gray-700 mb-2">Admin Notes</label>
                <textarea id="approve_admin_notes" name="admin_notes" rows="3"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                          placeholder="Optional notes"></textarea>
            </div>
            <div class="flex space-x-4">
                <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                    Approve
                </button>
                <button type="button" onclick="closeApproveModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Reject Modal -->
<div id="rejectModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
        <h3 class="text-2xl font-bold text-gray-900 mb-4">Reject Advertisement</h3>
        <form id="rejectForm" method="POST" class="space-y-4">
            <div>
                <label for="reject_admin_notes" class="block text-sm font-medium text-gray-700 mb-2">Reason for Rejection</label>
                <textarea id="reject_admin_notes" name="admin_notes" rows="3" required
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                          placeholder="Please provide a reason for rejection"></textarea>
            </div>
            <div class="flex space-x-4">
                <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                    Reject
                </button>
                <button type="button" onclick="closeRejectModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- View Advert Details Modal -->
<div id="viewAdvertModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" onclick="if(event.target === this) closeViewAdvertModal();">
    <div class="bg-white rounded-lg p-8 max-w-3xl w-full mx-4 my-8" onclick="event.stopPropagation();">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold text-gray-900">Advertisement Details</h3>
            <button onclick="closeViewAdvertModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        
        <div id="advertDetailsContent" class="space-y-6">
            <!-- Content will be populated by JavaScript -->
        </div>
        
        <div class="mt-6 flex justify-end">
            <button onclick="closeViewAdvertModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                Close
            </button>
        </div>
    </div>
</div>

<script>
const advertsData = [
    {% for advert in adverts %}
    {
        id: "{{ advert.id }}",
        title: "{{ advert.title|e }}",
        description: "{{ (advert.description or '')|e }}",
        link_url: "{{ (advert.link_url or '')|e }}",
        amount: {{ advert.amount or 0 }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

function showApproveModal(advertId) {
    const modal = document.getElementById('approveModal');
    const form = document.getElementById('approveForm');
    form.action = `/admin/advert/${advertId}/approve`;
    modal.classList.remove('hidden');
}

function closeApproveModal() {
    document.getElementById('approveModal').classList.add('hidden');
}

function showRejectModal(advertId) {
    const modal = document.getElementById('rejectModal');
    const form = document.getElementById('rejectForm');
    form.action = `/admin/advert/${advertId}/reject`;
    modal.classList.remove('hidden');
}

function closeRejectModal() {
    document.getElementById('rejectModal').classList.add('hidden');
}

function showAdvertDetails(advertId) {
    const advertRow = document.querySelector(`[data-advert-id="${advertId}"]`);
    const modal = document.getElementById('viewAdvertModal');
    const content = document.getElementById('advertDetailsContent');
    
    if (advertRow) {
        const title = advertRow.dataset.title || 'N/A';
        const description = advertRow.dataset.description || 'N/A';
        const linkUrl = advertRow.dataset.linkUrl || 'N/A';
        const buttonText = advertRow.dataset.buttonText || 'Learn More';
        const imageUrl = advertRow.dataset.imageUrl || '';
        const amount = parseFloat(advertRow.dataset.amount) || 0;
        const weeks = parseInt(advertRow.dataset.weeks) || 1;
        const status = advertRow.dataset.status || 'N/A';
        const paymentStatus = advertRow.dataset.paymentStatus || 'N/A';
        const submittedBy = advertRow.dataset.submittedBy || 'N/A';
        const submittedAt = advertRow.dataset.submittedAt || 'N/A';
        const approvedAt = advertRow.dataset.approvedAt || 'N/A';
        const startDate = advertRow.dataset.startDate || 'N/A';
        const endDate = advertRow.dataset.endDate || 'N/A';
        const adminNotes = advertRow.dataset.adminNotes || 'N/A';
        
        // Status badge HTML
        let statusBadge = '';
        if (status === 'pending') {
            statusBadge = '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>';
        } else if (status === 'approved') {
            statusBadge = '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Approved</span>';
        } else if (status === 'active') {
            statusBadge = '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Active</span>';
        } else if (status === 'expired') {
            statusBadge = '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Expired</span>';
        } else if (status === 'rejected') {
            statusBadge = '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Rejected</span>';
        }
        
        // Payment status badge HTML
        let paymentBadge = '';
        if (paymentStatus === 'paid') {
            paymentBadge = '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Paid</span>';
        } else if (paymentStatus === 'pending') {
            paymentBadge = '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>';
        } else {
            paymentBadge = '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Unpaid</span>';
        }
        
        // Build the content HTML
        content.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <p class="text-gray-900 font-semibold">${escapeHtml(title)}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <p>${statusBadge}</p>
                </div>
            </div>
            
            ${imageUrl ? `
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Image</label>
                <img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(title)}" 
                     class="max-w-full h-auto rounded-lg border border-gray-300" 
                     style="max-height: 400px; object-fit: contain;">
            </div>
            ` : ''}
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <p class="text-gray-900 whitespace-pre-wrap">${escapeHtml(description || 'No description provided')}</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Link URL</label>
                    <p class="text-gray-900 break-all">
                        ${linkUrl !== 'N/A' && linkUrl ? `<a href="${escapeHtml(linkUrl)}" target="_blank" class="text-blue-600 hover:underline">${escapeHtml(linkUrl)}</a>` : 'N/A'}
                    </p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Button Text</label>
                    <p class="text-gray-900">${escapeHtml(buttonText)}</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Duration</label>
                    <p class="text-gray-900 font-semibold">${weeks} week${weeks > 1 ? 's' : ''}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                    <p class="text-gray-900 font-semibold">${amount > 0 ? '‚Ç¶' + amount.toFixed(2) : 'Free'}</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                    <p>${paymentBadge}</p>
                </div>
                ${startDate !== 'N/A' && endDate !== 'N/A' ? `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Running Period</label>
                    <p class="text-gray-900">
                        <strong>Start:</strong> ${escapeHtml(startDate)}<br>
                        <strong>End:</strong> ${escapeHtml(endDate)}
                    </p>
                </div>
                ` : ''}
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Submitted By</label>
                    <p class="text-gray-900">${escapeHtml(submittedBy)}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Submitted At</label>
                    <p class="text-gray-900">${escapeHtml(submittedAt)}</p>
                </div>
            </div>
            
            ${approvedAt !== 'N/A' ? `
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Approved At</label>
                <p class="text-gray-900">${escapeHtml(approvedAt)}</p>
            </div>
            ` : ''}
            
            ${adminNotes !== 'N/A' && adminNotes ? `
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Admin Notes</label>
                <p class="text-gray-900 whitespace-pre-wrap bg-gray-50 p-3 rounded border border-gray-200">${escapeHtml(adminNotes)}</p>
            </div>
            ` : ''}
        `;
        
        modal.classList.remove('hidden');
    } else {
        alert('Advert details not found.');
    }
}

function closeViewAdvertModal() {
    document.getElementById('viewAdvertModal').classList.add('hidden');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}

